{% extends "core/templates/base.html" %} {% block title %}Projects Dashboard{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='/views/project/static/css/projects.css') }}"
/>
{% endblock %} {% block content %}
<div class="projects-container">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="page-title">
            <i class="fas fa-project-diagram text-primary me-2"></i>
            Projects Dashboard
          </h1>
          <p class="text-muted">Manage and track all your projects</p>
        </div>
        <div>
          <a href="/projects/new" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>New Project
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  {% if success_message %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ success_message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-folder text-primary" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.total }}</div>
        <div class="stats-label">Total Projects</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-clipboard-list text-secondary"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.planning }}</div>
        <div class="stats-label">Planning</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-spinner text-warning" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.in_progress }}</div>
        <div class="stats-label">In Progress</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-check-circle text-success"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.completed }}</div>
        <div class="stats-label">Completed</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-dollar-sign text-info" style="font-size: 1.5rem"></i>
        <div class="stats-number">
          ${{ "{:,.0f}".format(stats.total_budget) }}
        </div>
        <div class="stats-label">Total Budget</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-chart-line text-purple" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.avg_progress }}%</div>
        <div class="stats-label">Avg Progress</div>
      </div>
    </div>
  </div>

  <!-- Projects Grid -->
  <div class="row">
    {% if projects %} {% for project in projects %}
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="project-card">
        <div class="project-header">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="project-title">
              <a href="/projects/{{ project.id }}" class="text-decoration-none">
                {{ project.name }}
              </a>
            </h5>
            <span
              class="badge project-status status-{{ project.status.lower().replace(' ', '-') }}"
            >
              {{ project.status }}
            </span>
          </div>
          <p class="project-description text-muted">
            {% if project.description %} {{ project.description[:100] }}{% if
            project.description|length > 100 %}...{% endif %} {% else %} No
            description available {% endif %}
          </p>
        </div>

        <div class="project-body">
          <!-- Progress Bar -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Progress</small>
              <small class="text-muted">{{ project.progress }}%</small>
            </div>
            <div class="progress" style="height: 6px">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: {{ project.progress }}%"
                aria-valuenow="{{ project.progress }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>

          <!-- Project Info -->
          <div class="row text-center">
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.task_count }}</div>
                <div class="stat-label">Tasks</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.completed_tasks }}</div>
                <div class="stat-label">Done</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">
                  ${{ "{:,.0f}".format(project.budget) }}
                </div>
                <div class="stat-label">Budget</div>
              </div>
            </div>
          </div>
        </div>

        <div class="project-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if project.start_date %} Started: {{
              project.start_date.strftime('%m/%d/%y') }} {% else %} Not started
              {% endif %}
            </small>
            <div class="project-actions">
              <a
                href="/projects/{{ project.id }}"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="fas fa-eye"></i>
              </a>
              <a
                href="/projects/{{ project.id }}/edit"
                class="btn btn-sm btn-outline-secondary"
              >
                <i class="fas fa-edit"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="col-12">
      <div class="empty-state text-center py-5">
        <i
          class="fas fa-folder-open text-muted"
          style="font-size: 4rem; opacity: 0.3"
        ></i>
        <h3 class="mt-3 text-muted">No Projects Found</h3>
        <p class="text-muted">Get started by creating your first project</p>
        <a href="/projects/new" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Create Your First Project
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Quick Task Status Update Widget (for testing notifications) -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-tasks me-2"></i>Quick Task Status Update (Demo)
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <label for="taskSelect" class="form-label">Select Task:</label>
              <select class="form-select" id="taskSelect">
                <option value="">Loading tasks...</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="statusSelect" class="form-label">New Status:</label>
              <select class="form-select" id="statusSelect">
                <option value="NOT_STARTED">Not Started</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
                <option value="BLOCKED">Blocked</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <button
                class="btn btn-success d-block"
                onclick="updateTaskStatus()"
              >
                <i class="fas fa-sync me-2"></i>Update Status
              </button>
            </div>
            <div class="col-md-2">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-info d-block" onclick="loadTasks()">
                <i class="fas fa-refresh me-2"></i>Refresh
              </button>
            </div>
          </div>
          <div id="updateResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', path='/views/project/static/js/projects.js') }}"></script>

<!-- Task Status Update Demo Script -->
<script>
  // Load tasks for the demo widget
  async function loadTasks() {
    try {
      const taskSelect = document.getElementById("taskSelect");
      taskSelect.innerHTML = '<option value="">Loading tasks...</option>';

      // For demo purposes, we'll load tasks from all projects
      // Try project ID 1 first, then try to create some sample tasks if none exist
      let response = await fetch("/api/tasks/project/1", {
        headers: {
          Accept: "application/json",
        },
      });

      let tasks = [];
      if (response.ok) {
        tasks = await response.json();
      }

      // If no tasks found, try to create some sample tasks
      if (tasks.length === 0) {
        await createSampleTasks();
        // Try loading again
        response = await fetch("/api/tasks/project/1", {
          headers: {
            Accept: "application/json",
          },
        });
        if (response.ok) {
          tasks = await response.json();
        }
      }

      taskSelect.innerHTML = '<option value="">Select a task...</option>';
      tasks.forEach((task) => {
        const option = document.createElement("option");
        option.value = task.id;
        option.textContent = `${task.name} (${task.status})`;
        taskSelect.appendChild(option);
      });

      document.getElementById(
        "updateResult"
      ).innerHTML = `<div class="alert alert-info">Loaded ${tasks.length} tasks</div>`;
    } catch (error) {
      console.error("Error loading tasks:", error);
      document.getElementById("updateResult").innerHTML =
        '<div class="alert alert-warning">Failed to load tasks. This demo requires a project with ID 1 to exist.</div>';
    }
  }

  // Create sample tasks for testing
  async function createSampleTasks() {
    const sampleTasks = [
      {
        name: "Design UI mockups",
        description: "Create user interface mockups for the new feature",
        project_id: 1,
      },
      {
        name: "Implement backend API",
        description: "Develop REST API endpoints for data management",
        project_id: 1,
      },
      {
        name: "Write unit tests",
        description: "Create comprehensive unit tests for all modules",
        project_id: 1,
      },
    ];

    for (const taskData of sampleTasks) {
      try {
        await fetch("/api/tasks/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(taskData),
        });
      } catch (error) {
        console.log("Could not create sample task:", error);
      }
    }
  }

  // Update task status and trigger notifications
  async function updateTaskStatus() {
    try {
      const taskId = document.getElementById("taskSelect").value;
      const newStatus = document.getElementById("statusSelect").value;

      if (!taskId) {
        document.getElementById("updateResult").innerHTML =
          '<div class="alert alert-warning">Please select a task first</div>';
        return;
      }

      const response = await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({
          status: newStatus,
        }),
      });

      if (response.ok) {
        const updatedTask = await response.json();
        document.getElementById(
          "updateResult"
        ).innerHTML = `<div class="alert alert-success">
          <i class="fas fa-check me-2"></i>
          Task "${updatedTask.name}" status updated to "${updatedTask.status}"! 
          <br><small>Check the notification bell for real-time updates!</small>
        </div>`;

        // Refresh the task list
        await loadTasks();
      } else {
        const error = await response.json();
        document.getElementById(
          "updateResult"
        ).innerHTML = `<div class="alert alert-danger">Failed to update task: ${error.detail}</div>`;
      }
    } catch (error) {
      console.error("Error updating task:", error);
      document.getElementById(
        "updateResult"
      ).innerHTML = `<div class="alert alert-danger">Error updating task: ${error.message}</div>`;
    }
  }

  // Load tasks when page loads
  document.addEventListener("DOMContentLoaded", function () {
    // Add a small delay to let the user authentication settle
    setTimeout(loadTasks, 1000);
  });
</script>
{% endblock %}
