{% extends "core/templates/base.html" %} {% block title %}Projects Dashboard{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', path='/views/project/static/css/projects.css') }}"
/>
{% endblock %} {% block content %}
<div class="projects-container">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="page-title">
            <i class="fas fa-project-diagram text-primary me-2"></i>
            Projects Dashboard
          </h1>
          <p class="text-muted">Manage and track all your projects</p>
        </div>        <div>
          <a href="/projects/new" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>New Project
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  {% if success_message %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ success_message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-folder text-primary" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.total }}</div>
        <div class="stats-label">Total Projects</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-clipboard-list text-secondary"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.planning }}</div>
        <div class="stats-label">Planning</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-spinner text-warning" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.in_progress }}</div>
        <div class="stats-label">In Progress</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-check-circle text-success"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.completed }}</div>
        <div class="stats-label">Completed</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-dollar-sign text-info" style="font-size: 1.5rem"></i>
        <div class="stats-number">
          ${{ "{:,.0f}".format(stats.total_budget) }}
        </div>
        <div class="stats-label">Total Budget</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-chart-line text-purple" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.avg_progress }}%</div>
        <div class="stats-label">Avg Progress</div>
      </div>
    </div>
  </div>  <!-- Projects Grid -->
  <div class="row">
    {% if projects %}
    {% for project in projects %}<div class="col-lg-4 col-md-6 mb-4">
      <div class="project-card">        <div class="project-header">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="project-title">
              <a href="/projects/{{ project.id }}" class="text-decoration-none">
                {{ project.name }}
              </a>
            </h5>
            <span
              class="badge project-status status-{{ project.status.lower().replace(' ', '-') }}"
            >
              {{ project.status }}
            </span>
          </div>
          <p class="project-description text-muted">
            {% if project.description %} {{ project.description[:100] }}{% if
            project.description|length > 100 %}...{% endif %} {% else %} No
            description available {% endif %}
          </p>
        </div>

        <div class="project-body">
          <!-- Progress Bar -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Progress</small>
              <small class="text-muted">{{ project.progress }}%</small>
            </div>
            <div class="progress" style="height: 6px">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: {{ project.progress }}%"
                aria-valuenow="{{ project.progress }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>

          <!-- Project Info -->
          <div class="row text-center">
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.task_count }}</div>
                <div class="stat-label">Tasks</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.completed_tasks }}</div>
                <div class="stat-label">Done</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">
                  ${{ "{:,.0f}".format(project.budget) }}
                </div>
                <div class="stat-label">Budget</div>
              </div>
            </div>
          </div>
        </div>

        <div class="project-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if project.start_date %} Started: {{
              project.start_date.strftime('%m/%d/%y') }} {% else %} Not started
              {% endif %}
            </small>
            <div class="project-actions">
              <a
                href="/projects/{{ project.id }}"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="fas fa-eye"></i>
              </a>
              <a
                href="/projects/{{ project.id }}/edit"
                class="btn btn-sm btn-outline-secondary"
              >
                <i class="fas fa-edit"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="col-12">
      <div class="empty-state text-center py-5">
        <i
          class="fas fa-folder-open text-muted"
          style="font-size: 4rem; opacity: 0.3"
        ></i>
        <h3 class="mt-3 text-muted">No Projects Found</h3>
        <p class="text-muted">Get started by creating your first project</p>
        <a href="/projects/new" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Create Your First Project
        </a>
      </div>
    </div>
    {% endif %}
  </div>
  {% if error %}
  <div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', path='/views/project/static/js/projects.js') }}"></script>
{% endblock %}
  document.addEventListener("DOMContentLoaded", function () {
    console.log("🚀 JavaScript is loading...");
    
    // Test - make delete button visible for 3 seconds as a test
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    if (deleteBtn) {
      console.log("✅ Found delete button, making it visible for 3 seconds as test...");
      deleteBtn.style.display = 'inline-block';
      deleteBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Button Test';
      
      setTimeout(() => {
        deleteBtn.style.display = 'none';
        console.log("✅ Test complete, hiding button. Now initializing proper functionality...");
        // Initialize project deletion functionality
        initializeProjectDeletion();
      }, 3000);
    } else {
      console.error("❌ Delete button not found!");
      // Initialize anyway
      initializeProjectDeletion();
    }
  });
  
  function initializeProjectDeletion() {
    const checkboxes = document.querySelectorAll('.project-checkbox');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    console.log('Initializing project deletion functionality...');
    console.log('Found checkboxes:', checkboxes.length);
    console.log('Delete button:', deleteBtn);
    
    if (!deleteBtn) {
      console.error('Delete button not found!');
      return;
    }
    
    function updateDeleteButton() {
      const selectedCheckboxes = document.querySelectorAll('.project-checkbox:checked');
      console.log('Selected checkboxes:', selectedCheckboxes.length);
      
      if (selectedCheckboxes.length > 0) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.innerHTML = `<i class="fas fa-trash me-2"></i>Delete ${selectedCheckboxes.length} Selected`;
        console.log('Showing delete button');
      } else {
        deleteBtn.style.display = 'none';
        console.log('Hiding delete button');
      }
      
      // Update select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < checkboxes.length;
        selectAllCheckbox.checked = selectedCheckboxes.length === checkboxes.length && checkboxes.length > 0;
      }
    }
    
    // Add event listeners to project checkboxes
    checkboxes.forEach((checkbox, index) => {
      checkbox.addEventListener('change', function() {
        console.log(`Checkbox ${index} changed:`, this.checked);
        updateDeleteButton();
      });
    });
    
    // Handle select all checkbox
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        console.log('Select all changed:', this.checked);
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateDeleteButton();
      });
    }
      // Handle delete button click - THIS IS THE IMPORTANT PART
    deleteBtn.addEventListener('click', async function() {
      console.log('Delete button clicked!');
      
      const selectedCheckboxes = document.querySelectorAll('.project-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
      
      console.log('Selected project IDs:', selectedIds);
      
      if (selectedIds.length === 0) {
        alert('Please select projects to delete.');
        return;
      }
      
      const confirmMessage = `Are you sure you want to delete ${selectedIds.length} project${selectedIds.length > 1 ? 's' : ''}? This action cannot be undone.`;
      
      if (!confirm(confirmMessage)) {
        console.log('User cancelled deletion');
        return;
      }
      
      try {
        console.log('Starting deletion process...');
        
        let successCount = 0;
        let failedProjects = [];
        
        // Delete each project individually using the existing API
        for (const projectId of selectedIds) {
          try {
            console.log(`Deleting project ${projectId}...`);
            
            const response = await fetch(`/api/projects/${projectId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            
            if (response.ok) {
              console.log(`✅ Successfully deleted project ${projectId}`);
              successCount++;
            } else {
              console.error(`❌ Failed to delete project ${projectId}:`, response.status);
              failedProjects.push(projectId);
            }
          } catch (error) {
            console.error(`❌ Error deleting project ${projectId}:`, error);
            failedProjects.push(projectId);
          }
        }
        
        // Show results to user
        if (failedProjects.length === 0) {
          alert(`Successfully deleted ${successCount} project${successCount > 1 ? 's' : ''}!`);
        } else {
          alert(`Deleted ${successCount} project${successCount > 1 ? 's' : ''} successfully. ${failedProjects.length} project${failedProjects.length > 1 ? 's' : ''} could not be deleted.`);
        }
        
        // Reload the page to refresh the project list
        console.log('Reloading page to refresh project list...');
        window.location.reload();
        
      } catch (error) {
        console.error('Error in deletion process:', error);
        alert('An error occurred while deleting projects. Please try again.');
      }
    });
    
    console.log('✅ Project deletion functionality initialized');
  }
</script>
{% endblock %}
