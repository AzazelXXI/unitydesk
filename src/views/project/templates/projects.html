{% extends "core/templates/base.html" %} {% block title %}Projects Dashboard{%
endblock %} {% block head_extra %}
<link
  rel="stylesheet"
  href="{{ url_for('project_static', path='css/projects.css') }}?v=999999"
/>
{% endblock %} {% block content %}
<div class="projects-container">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="page-title">
            <i class="fas fa-project-diagram text-primary me-2"></i>
            Projects Dashboard
          </h1>
          <p class="text-muted">Manage and track all your projects</p>
        </div>
        <div>
          <a href="/projects/new" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>New Project
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card filter-section">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-filter me-2"></i>Filter & Sort Projects
          </h6>
        </div>
        <div class="card-body">
          <form method="GET" action="/projects" id="filterForm">
            <div class="row g-3">
              <!-- Search -->
              <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input
                  type="text"
                  class="form-control"
                  id="search"
                  name="search"
                  placeholder="Project name or description..."
                  value="{{ current_search }}"
                />
              </div>

              <!-- Status Filter -->
              <div class="col-md-2">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                  {% for option in status_options %}
                  <option 
                    value="{{ option.value }}" 
                    {% if option.value == current_status %}selected{% endif %}
                  >
                    {{ option.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <!-- Sort By -->
              <div class="col-md-2">
                <label for="sort_by" class="form-label">Sort By</label>
                <select class="form-select" id="sort_by" name="sort_by">
                  {% for option in sort_options %}
                  <option 
                    value="{{ option.value }}" 
                    {% if option.value == current_sort_by %}selected{% endif %}
                  >
                    {{ option.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <!-- Sort Order -->
              <div class="col-md-2">
                <label for="sort_order" class="form-label">Order</label>
                <select class="form-select" id="sort_order" name="sort_order">
                  <option value="desc" {% if current_sort_order == 'desc' %}selected{% endif %}>
                    Descending
                  </option>
                  <option value="asc" {% if current_sort_order == 'asc' %}selected{% endif %}>
                    Ascending
                  </option>
                </select>
              </div>

              <!-- Apply Filters Button -->
              <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-1"></i>Apply
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-folder text-primary" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.total }}</div>
        <div class="stats-label">Total Projects</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-clipboard-list text-secondary"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.planning }}</div>
        <div class="stats-label">Planning</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-spinner text-warning" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.in_progress }}</div>
        <div class="stats-label">In Progress</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i
          class="fas fa-check-circle text-success"
          style="font-size: 1.5rem"
        ></i>
        <div class="stats-number">{{ stats.completed }}</div>
        <div class="stats-label">Completed</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-dollar-sign text-info" style="font-size: 1.5rem"></i>
        <div class="stats-number">
          ${{ "{:,.0f}".format(stats.total_budget) }}
        </div>
        <div class="stats-label">Total Budget</div>
      </div>
    </div>
    <div class="col-6 col-md-2 mb-3 mb-md-0">
      <div class="stats-card bg-white">
        <i class="fas fa-chart-line text-purple" style="font-size: 1.5rem"></i>
        <div class="stats-number">{{ stats.avg_progress }}%</div>
        <div class="stats-label">Avg Progress</div>
      </div>
    </div>
  </div>
  <!-- Projects Grid -->
  <div class="row">
    {% if projects %} {% for project in projects %}
    <div class="col-lg-4 col-md-6 mb-4">
      <div
        class="project-card clickable-card"
        onclick="window.location.href='/projects/{{ project.id }}'"
      >
        <div class="project-header">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="project-title">{{ project.name }}</h5>
            <span
              class="badge project-status status-{{ project.status.lower().replace(' ', '-') }}"
            >
              {{ project.status }}
            </span>
          </div>
          <p class="project-description text-muted">
            {% if project.description %} {{ project.description[:100] }}{% if
            project.description|length > 100 %}...{% endif %} {% else %} No
            description available {% endif %}
          </p>
        </div>

        <div class="project-body">
          <!-- Progress Bar -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Progress</small>
              <small class="text-muted">{{ project.progress }}%</small>
            </div>
            <div class="progress" style="height: 6px">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: {{ project.progress }}%"
                aria-valuenow="{{ project.progress }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>

          <!-- Project Info -->
          <div class="row text-center">
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.task_count }}</div>
                <div class="stat-label">Tasks</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">{{ project.completed_tasks }}</div>
                <div class="stat-label">Done</div>
              </div>
            </div>
            <div class="col-4">
              <div class="project-stat">
                <div class="stat-number">
                  ${{ "{:,.0f}".format(project.budget) }}
                </div>
                <div class="stat-label">Budget</div>
              </div>
            </div>
          </div>
        </div>

        <div class="project-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if project.start_date %} Started: {{
              project.start_date.strftime('%m/%d/%y') }} {% else %} Not started
              {% endif %}
            </small>
            <div class="project-actions">
              <a
                href="/projects/{{ project.id }}"
                class="btn btn-sm btn-outline-primary"
                onclick="event.stopPropagation()"
              >
                <i class="fas fa-eye"></i>
              </a>
              <a
                href="/projects/{{ project.id }}/edit"
                class="btn btn-sm btn-outline-secondary"
                onclick="event.stopPropagation()"
              >
                <i class="fas fa-edit"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="col-12">
      <div class="empty-state text-center py-5">
        {% if current_search or current_status != 'all' or current_sort_by != 'created_at' %}
        <!-- Filtered but no results -->
        <i
          class="fas fa-search text-muted"
          style="font-size: 4rem; opacity: 0.3"
        ></i>
        <h3 class="mt-3 text-muted">No Projects Match Your Filters</h3>
        <p class="text-muted mb-3">
          Sorry, we couldn't find any projects matching your current search criteria.
          <br>
          Try adjusting your filters or search terms to find what you're looking for.
        </p>
        <div class="d-flex gap-2 justify-content-center">
          <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
            <i class="fas fa-times me-1"></i>Clear All Filters
          </button>
          <a href="/projects/new" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create New Project
          </a>
        </div>
        {% else %}
        <!-- No projects at all -->
        <i
          class="fas fa-folder-open text-muted"
          style="font-size: 4rem; opacity: 0.3"
        ></i>
        <h3 class="mt-3 text-muted">No Projects Yet</h3>
        <p class="text-muted mb-3">
          You haven't created any projects yet. 
          <br>
          Get started by creating your first project to organize your work.
        </p>
        <a href="/projects/new" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Create Your First Project
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% if error %}
  <div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>
  {% endif %}
</div>

<!-- Success Modal for Project Creation -->
<div
  class="modal fade"
  id="projectCreatedModal"
  tabindex="-1"
  aria-labelledby="projectCreatedModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="projectCreatedModalLabel">
          <i class="fas fa-check-circle me-2"></i>Success!
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i
            class="fas fa-check-circle-fill text-success"
            style="font-size: 3rem"
          ></i>
        </div>
        <h4>Project Created Successfully!</h4>
        <p class="text-muted">
          Your new project has been created and is ready for you to start
          working on.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">
          <i class="fas fa-arrow-right me-2"></i>Continue
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script src="{{ url_for('project_static', path='js/projects.js') }}"></script>
{% endblock %} {% block scripts %}
<script>
  // Filter and sorting functions
  function clearFilters() {
    // Reset all form fields
    document.getElementById('search').value = '';
    document.getElementById('status').value = 'all';
    document.getElementById('sort_by').value = 'created_at';
    document.getElementById('sort_order').value = 'desc';
    
    // Submit the form to apply cleared filters
    document.getElementById('filterForm').submit();
  }

  // Auto-submit on select changes for better UX
  document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('#status, #sort_by, #sort_order');
    selects.forEach(select => {
      select.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
      });
    });

    // Add debounced search
    let searchTimeout;
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        document.getElementById('filterForm').submit();
      }, 500); // 500ms delay
    });

    // Handle Enter key in search
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout);
        document.getElementById('filterForm').submit();
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    // Check if we came from project creation (look for hash fragment)
    if (window.location.hash === "#project-created") {
      // Show the success modal
      const modal = new bootstrap.Modal(
        document.getElementById("projectCreatedModal")
      );
      modal.show();

      // Clean up the URL hash without affecting browser history
      history.replaceState(null, "", window.location.pathname);
    }
  });
</script>
{% endblock %}
