{% extends "core/templates/base.html" %}

{% block title %}Create New Project{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/views/project/static/css/projects.css') }}">
<style>
.project-form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.form-section {
    background: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.form-section h4 {
    color: #495057;
    margin-bottom: 20px;
    font-weight: 600;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: none;
    padding: 12px 30px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

.btn-secondary {
    border-radius: 8px;
    padding: 12px 30px;
    font-weight: 600;
}

.invalid-feedback {
    display: block;
}

.loading-spinner {
    display: none;
}

.success-message {
    display: none;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 15px;
    color: #155724;
    margin-bottom: 20px;
}

.error-message {
    display: none;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 15px;
    color: #721c24;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="project-form-container">
    <!-- Header -->
    <div class="text-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
                <li class="breadcrumb-item active">New Project</li>
            </ol>
        </nav>
        
        <h1 class="display-5 fw-bold text-primary mb-2">
            <i class="fas fa-plus-circle me-2"></i>Create New Project
        </h1>
        <p class="lead text-muted">Set up a new project with all the necessary details</p>
    </div>

    <!-- Messages -->
    <div id="successMessage" class="success-message">
        <i class="fas fa-check-circle me-2"></i>
        <span id="successText">Project created successfully!</span>
    </div>
    
    <div id="errorMessage" class="error-message">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText">There was an error creating the project.</span>
    </div>

    <!-- Form -->
    <form id="newProjectForm" novalidate>
        <!-- Basic Information -->
        <div class="form-section">
            <h4><i class="fas fa-info-circle text-primary me-2"></i>Basic Information</h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label fw-semibold">Project Name *</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                    <div class="invalid-feedback">Please provide a project name.</div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="client_name" class="form-label fw-semibold">Client Name</label>
                    <input type="text" class="form-control" id="client_name" name="client_name">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label fw-semibold">Description *</label>
                <textarea class="form-control" id="description" name="description" rows="3" required
                    placeholder="Describe the project goals, scope, and objectives..."></textarea>
                <div class="invalid-feedback">Please provide a project description.</div>
            </div>
        </div>

        <!-- Project Details -->
        <div class="form-section">
            <h4><i class="fas fa-cogs text-primary me-2"></i>Project Details</h4>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="status" class="form-label fw-semibold">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="Planning">Planning</option>
                        <option value="In Progress">In Progress</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="priority" class="form-label fw-semibold">Priority</label>
                    <select class="form-select" id="priority" name="priority">
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="budget" class="form-label fw-semibold">Budget ($)</label>
                    <input type="number" class="form-control" id="budget" name="budget" min="0" step="0.01">
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="form-section">
            <h4><i class="fas fa-calendar-alt text-primary me-2"></i>Timeline</h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="start_date" class="form-label fw-semibold">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="end_date" class="form-label fw-semibold">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date">
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
            <h4><i class="fas fa-tags text-primary me-2"></i>Additional Information</h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="department" class="form-label fw-semibold">Department</label>
                    <input type="text" class="form-control" id="department" name="department">
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="project_manager" class="form-label fw-semibold">Project Manager</label>
                    <input type="text" class="form-control" id="project_manager" name="project_manager">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="goals" class="form-label fw-semibold">Project Goals</label>
                <textarea class="form-control" id="goals" name="goals" rows="2"
                    placeholder="List the main goals and deliverables..."></textarea>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="text-center">
            <button type="button" class="btn btn-secondary me-3" onclick="window.location.href='/projects'">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="submitText">
                    <i class="fas fa-plus me-2"></i>Create Project
                </span>
                <span id="loadingSpinner" class="loading-spinner">
                    <i class="fas fa-spinner fa-spin me-2"></i>Creating...
                </span>
            </button>
        </div>
    </form>
</div>

<script>
document.getElementById('newProjectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    
    submitBtn.disabled = true;
    submitText.style.display = 'none';
    loadingSpinner.style.display = 'inline';
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';
    
    // Clear previous validation
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    
    // Get form data
    const formData = new FormData(this);
    const projectData = Object.fromEntries(formData.entries());
    
    // Convert budget to number if provided
    if (projectData.budget) {
        projectData.budget = parseFloat(projectData.budget);
    }
    
    // Validate required fields
    let isValid = true;
    if (!projectData.name.trim()) {
        document.getElementById('name').classList.add('is-invalid');
        isValid = false;
    }
    if (!projectData.description.trim()) {
        document.getElementById('description').classList.add('is-invalid');
        isValid = false;
    }
    
    if (!isValid) {
        // Reset button state
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch('/api/projects/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(projectData)
        });
        
        if (response.ok) {
            const result = await response.json();
            successMessage.style.display = 'block';
            document.getElementById('successText').textContent = 'Project created successfully!';
            
            // Reset form
            this.reset();
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = '/projects';
            }, 2000);
        } else {
            const error = await response.json();
            errorMessage.style.display = 'block';
            document.getElementById('errorText').textContent = error.detail || 'Failed to create project';
        }
    } catch (error) {
        errorMessage.style.display = 'block';
        document.getElementById('errorText').textContent = 'Network error. Please try again.';
    }
    
    // Reset button state
    submitBtn.disabled = false;
    submitText.style.display = 'inline';
    loadingSpinner.style.display = 'none';
});

// Date validation
document.getElementById('start_date').addEventListener('change', function() {
    const endDateInput = document.getElementById('end_date');
    endDateInput.min = this.value;
});

document.getElementById('end_date').addEventListener('change', function() {
    const startDateInput = document.getElementById('start_date');
    if (startDateInput.value && this.value < startDateInput.value) {
        this.setCustomValidity('End date must be after start date');
    } else {
        this.setCustomValidity('');
    }
});
</script>
{% endblock %}
                >
                <input
                  type="text"
                  class="form-control"
                  id="projectName"
                  name="name"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="projectStatus" class="form-label">Status</label>
                <select class="form-select" id="projectStatus" name="status">
                  <option value="Planning" selected>Planning</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                  <option value="Canceled">Canceled</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label for="projectDescription" class="form-label"
                >Description</label
              >
              <textarea
                class="form-control"
                id="projectDescription"
                name="description"
                rows="4"
                placeholder="Describe what this project is about..."
              ></textarea>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="projectBudget" class="form-label">Budget</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    class="form-control"
                    id="projectBudget"
                    name="budget"
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                  />
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="startDate"
                  name="start_date"
                />
              </div>
              <div class="col-md-4 mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="endDate"
                  name="end_date"
                />
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="projectProgress" class="form-label"
                  >Initial Progress (%)</label
                >
                <input
                  type="range"
                  class="form-range"
                  id="projectProgress"
                  name="progress"
                  min="0"
                  max="100"
                  value="0"
                  oninput="updateProgressValue(this.value)"
                />
                <div class="d-flex justify-content-between">
                  <small class="text-muted">0%</small>
                  <small class="text-muted" id="progressValue">0%</small>
                  <small class="text-muted">100%</small>
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-12">
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Create Project
                  </button>
                  <button type="reset" class="btn btn-outline-secondary">
                    <i class="fas fa-undo me-2"></i>Reset Form
                  </button>
                  <a href="/projects" class="btn btn-outline-danger">
                    <i class="fas fa-times me-2"></i>Cancel
                  </a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer"></div>

{% endblock %} {% block extra_js %}
<script src="{{ url_for('static', path='/views/project/static/js/projects.js') }}"></script>
<script>
  // Update progress value display
  function updateProgressValue(value) {
    document.getElementById("progressValue").textContent = value + "%";
  }

  // Handle form submission
  document
    .getElementById("newProjectForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;

      // Show loading state
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(this);
        const projectData = Object.fromEntries(formData.entries());

        const response = await fetch("/api/projects", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(projectData),
        });

        if (response.ok) {
          const result = await response.json();

          // Show success message
          showMessage("Project created successfully!", "success");

          // Redirect to project details or projects list
          setTimeout(() => {
            window.location.href = `/projects/${result.id}`;
          }, 1500);
        } else {
          const error = await response.json();
          showMessage(
            `Error: ${error.detail || "Failed to create project"}`,
            "danger"
          );
        }
      } catch (error) {
        console.error("Error creating project:", error);
        showMessage("Failed to create project. Please try again.", "danger");
      } finally {
        // Restore button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

  // Show message function
  function showMessage(message, type) {
    const container = document.getElementById("messageContainer");
    const alert = document.createElement("div");
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

    container.appendChild(alert);

    // Auto dismiss after 5 seconds
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }

  // Set minimum end date to start date
  document.getElementById("startDate").addEventListener("change", function () {
    const endDateInput = document.getElementById("endDate");
    endDateInput.min = this.value;
  });
</script>
{% endblock %}
