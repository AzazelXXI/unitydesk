{% extends "core/templates/base.html" %} {% block title %}New Project | CSA
Platform{% endblock %} {% block head_extra %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<style>
  .section-card {
    margin-bottom: 20px;
    border-radius: 8px;
  }

  .section-card .card-header {
    border-radius: 8px 8px 0 0;
    background-color: #f8f9fa;
    font-weight: 500;
  }

  .section-divider {
    margin: 2rem 0;
    color: #6c757d;
    display: flex;
    align-items: center;
  }

  .section-divider::before,
  .section-divider::after {
    content: "";
    flex: 1;
    border-bottom: 1px solid #dee2e6;
  }

  .section-divider::before {
    margin-right: 0.5rem;
  }

  .section-divider::after {
    margin-left: 0.5rem;
  }

  .team-member-row {
    margin-bottom: 1rem;
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
  }

  .team-member-row:hover {
    background-color: #e9ecef;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Create New Project</h1>
    <a href="/project" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Projects
    </a>
  </div>

  <form id="newProjectForm" method="POST">
    <!-- Basic Information -->
    <div class="card section-card">
      <div class="card-header">
        <h5 class="mb-0">Basic Information</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-12 mb-3">
            <label for="projectName" class="form-label required"
              >Project Name</label
            >
            <input
              type="text"
              class="form-control"
              id="projectName"
              name="name"
              required
            />
          </div>
        </div>

        <div class="mb-3">
          <label for="projectDescription" class="form-label">Description</label>
          <textarea
            class="form-control"
            id="projectDescription"
            name="description"
            rows="3"
            placeholder="Describe the project objectives and scope"
          ></textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="projectStatus" class="form-label">Status</label>
            <select class="form-select" id="projectStatus" name="status">
              <option value="Planning">Planning</option>
              <option value="In Progress">In Progress</option>
              <option value="Completed">Completed</option>
              <option value="Canceled">Canceled</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline & Budget -->
    <div class="card section-card">
      <div class="card-header">
        <h5 class="mb-0">Timeline & Budget</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="startDate" class="form-label">Start Date</label>
            <input
              type="text"
              class="form-control datepicker"
              id="startDate"
              name="start_date"
              placeholder="Select date"
            />
          </div>
          <div class="col-md-6 mb-3">
            <label for="targetEndDate" class="form-label"
              >Target End Date</label
            >
            <input
              type="text"
              class="form-control datepicker"
              id="targetEndDate"
              name="target_end_date"
              placeholder="Select date"
            />
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="estimatedBudget" class="form-label"
              >Estimated Budget</label
            >
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input
                type="number"
                class="form-control"
                id="estimatedBudget"
                name="budget"
                placeholder="0.00"
                step="0.01"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-4 mb-5">
      <button
        type="button"
        class="btn btn-outline-secondary"
        onclick="window.location.href='/project'"
      >
        Cancel
      </button>
      <div>
        <button
          type="button"
          class="btn btn-outline-primary me-2"
          id="saveAsDraft"
        >
          <i class="bi bi-save"></i> Save as Planning
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-lg"></i> Create Project
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Success Modal -->
<div
  class="modal fade"
  id="successModal"
  tabindex="-1"
  aria-labelledby="successModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle"></i> Success!
        </h5>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i
            class="bi bi-check-circle-fill text-success"
            style="font-size: 3rem"
          ></i>
        </div>
        <h4>Project Created Successfully!</h4>
        <p class="text-muted">
          Your project has been created and saved to the database.
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" id="viewProjectBtn">
          <i class="bi bi-arrow-right"></i> View Project
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary"
          id="createAnotherBtn"
        >
          Create Another Project
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<!-- Flatpickr for date picking -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize date pickers
    flatpickr(".datepicker", {
      dateFormat: "Y-m-d",
      allowInput: true,
    });

    // Team members functionality
    const teamMembersContainer = document.getElementById(
      "teamMembersContainer"
    );
    const teamMemberTemplate = document.getElementById("teamMemberTemplate");
    const noTeamMembersAlert = document.getElementById("noTeamMembers");
    let teamMemberCount = 0;

    // Add team member button
    document
      .getElementById("addTeamMember")
      .addEventListener("click", function () {
        const teamMemberNode = teamMemberTemplate.content.cloneNode(true);
        const teamMemberRow = teamMemberNode.querySelector(".team-member-row");

        // Update the indices for the form fields to ensure unique names
        const currentIndex = teamMemberCount++;
        const userIdField = teamMemberNode.querySelector(
          ".team-member-user-id"
        );
        const roleField = teamMemberNode.querySelector(".team-member-role");
        const joinedAtField = teamMemberNode.querySelector(
          ".team-member-joined-at"
        );

        userIdField.name = `team_members[${currentIndex}][user_id]`;
        roleField.name = `team_members[${currentIndex}][role]`;
        joinedAtField.name = `team_members[${currentIndex}][joined_at]`;

        // Add remove event handler
        const removeButton = teamMemberNode.querySelector(
          ".remove-team-member"
        );
        removeButton.addEventListener("click", function () {
          teamMemberRow.remove();

          if (
            teamMembersContainer.querySelectorAll(".team-member-row").length ===
            0
          ) {
            noTeamMembersAlert.style.display = "block";
          }
        });

        // Hide the "no team members" message
        noTeamMembersAlert.style.display = "none";

        // Add the new row to the container
        teamMembersContainer.appendChild(teamMemberNode);

        // Initialize datepicker for the new field
        flatpickr(joinedAtField, {
          dateFormat: "Y-m-d",
          allowInput: true,
        });
      });

    // Save as draft button
    document
      .getElementById("saveAsDraft")
      .addEventListener("click", function () {
        document.getElementById("projectStatus").value = "Planning";
        document.getElementById("newProjectForm").submit();
      });

    // Form submission handling
    document
      .getElementById("newProjectForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        // Collect form data
        const formData = new FormData(this);

        // Convert empty string to empty string for estimated_budget (API will handle it)
        // No need to convert to JSON, send as FormData for the Form(...) API endpoint

        // Make API request
        fetch("/api/projects/", {
          method: "POST",
          credentials: "include", // Include cookies for authentication
          body: formData, // Send as FormData, not JSON
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((errorData) => {
                throw new Error(
                  errorData.detail || "Network response was not ok"
                );
              });
            }
            return response.json();
          })
          .then((data) => {
            // Store project data for later use
            window.newProjectData = data;

            // Update the modal content with the success message
            document.querySelector("#successModal .modal-body h4").textContent =
              data.message || "Project Created Successfully!";
            document.querySelector(
              "#successModal .modal-body p"
            ).textContent = `Project "${data.project_name}" has been created successfully.`;

            // Show success modal
            const successModal = new bootstrap.Modal(
              document.getElementById("successModal")
            );
            successModal.show();
          })
          .catch((error) => {
            console.error("Error:", error);
            // Show user-friendly error message
            alert(
              error.message ||
                "There was a problem creating the project. Please try again."
            );
          });
      });

    // Handle success modal buttons
    document
      .getElementById("viewProjectBtn")
      .addEventListener("click", function () {
        if (window.newProjectData && window.newProjectData.project_id) {
          window.location.href = `/project/${window.newProjectData.project_id}`;
        } else {
          // Fallback to projects list if no project_id
          window.location.href = "/project";
        }
      });

    document
      .getElementById("createAnotherBtn")
      .addEventListener("click", function () {
        // Hide the modal
        const successModal = bootstrap.Modal.getInstance(
          document.getElementById("successModal")
        );
        successModal.hide();

        // Reset the form
        document.getElementById("newProjectForm").reset();

        // Clear the stored project data
        window.newProjectData = null;
      });
  });
</script>
{% endblock %}
