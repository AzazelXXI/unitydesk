{% extends "base.html" %} {% block title %}Meeting Room | CSA Platform{%
endblock %} {% block head_extra %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<style>
  .meeting-container {
    background: #f8f9fa;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
  }

  .video-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    background-color: #000;
    border-radius: 8px;
    overflow: hidden;
  }

  .video-container .placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.2rem;
  }

  .video-controls {
    background: rgba(33, 37, 41, 0.8);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
  }

  .meeting-sidebar {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 15px;
    height: calc(100% - 20px);
  }

  .participant {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 5px;
    transition: background-color 0.2s;
  }

  .participant:hover {
    background-color: #f8f9fa;
  }

  .participant-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .chat-container {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    background-color: white;
  }

  .chat-message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    position: relative;
  }

  .message-mine {
    background-color: var(--primary-color);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
  }

  .message-other {
    background-color: #e9ecef;
    color: #212529;
    margin-right: auto;
    border-bottom-left-radius: 5px;
  }

  .message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 2px;
    text-align: right;
  }
</style>
{% endblock %} {% block header %}Meeting: {{ meeting.title }}{% endblock %} {%
block header_actions %}
<div class="btn-toolbar mb-2 mb-md-0">
  <div class="btn-group me-2">
    <button
      type="button"
      class="btn btn-sm btn-outline-secondary"
      id="inviteBtn"
    >
      <i class="bi bi-person-plus"></i> Invite
    </button>
    <button
      type="button"
      class="btn btn-sm btn-outline-secondary"
      id="shareBtn"
    >
      <i class="bi bi-share"></i> Share
    </button>
  </div>
  <button type="button" class="btn btn-sm btn-danger" id="leaveBtn">
    <i class="bi bi-box-arrow-right"></i> Leave Meeting
  </button>
</div>
{% endblock %} {% block content %}
<div class="row g-3 mb-4">
  <!-- Main video area -->
  <div class="col-md-8">
    <div class="meeting-container">
      <div class="video-container">
        <div class="placeholder">
          <div class="text-center">
            <i class="bi bi-camera-video-off fs-1"></i>
            <p>Waiting for video connection...</p>
          </div>
        </div>
        <!-- Video will be inserted here via JavaScript -->
      </div>

      <div class="video-controls d-flex justify-content-center">
        <button class="btn btn-light mx-1" id="btnMute" title="Mute/Unmute">
          <i class="bi bi-mic"></i>
        </button>
        <button class="btn btn-light mx-1" id="btnVideo" title="Video On/Off">
          <i class="bi bi-camera-video"></i>
        </button>
        <button class="btn btn-light mx-1" id="btnScreen" title="Share Screen">
          <i class="bi bi-display"></i>
        </button>
        <button class="btn btn-light mx-1" id="btnSettings" title="Settings">
          <i class="bi bi-gear"></i>
        </button>
        <button class="btn btn-light mx-1" id="btnMore" title="More Options">
          <i class="bi bi-three-dots"></i>
        </button>
      </div>
    </div>

    <!-- Meeting information -->
    <div class="card mb-4">
      <div class="card-header">Meeting Information</div>
      <div class="card-body">
        <h5 class="card-title">{{ meeting.title }}</h5>
        <p class="card-text">{{ meeting.description }}</p>

        <div class="row g-2">
          <div class="col-md-6">
            <div class="mb-2">
              <strong><i class="bi bi-calendar-event"></i> Date:</strong>
              <span>{{ meeting.date_formatted }}</span>
            </div>
            <div class="mb-2">
              <strong><i class="bi bi-clock"></i> Time:</strong>
              <span>{{ meeting.start_time }} - {{ meeting.end_time }}</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-2">
              <strong><i class="bi bi-person"></i> Organizer:</strong>
              <span>{{ meeting.organizer }}</span>
            </div>
            <div class="mb-2">
              <strong><i class="bi bi-link-45deg"></i> Meeting Link:</strong>
              <span class="text-primary">{{ request.url }}</span>
              <button
                class="btn btn-sm btn-outline-secondary ms-2"
                id="copyLink"
              >
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar with participants and chat -->
  <div class="col-md-4">
    <!-- Participants -->
    <div class="meeting-sidebar mb-3">
      <h5>
        <i class="bi bi-people"></i> Participants ({{ participants|length }})
      </h5>
      <hr />
      <div id="participantsList">
        {% for participant in participants %}
        <div class="participant">
          <div class="participant-avatar">{{ participant.initials }}</div>
          <div class="flex-grow-1">
            <div>{{ participant.name }}</div>
            <small class="text-muted">{{ participant.role }}</small>
          </div>
          {% if participant.is_speaking %}
          <div class="ms-auto">
            <i class="bi bi-mic-fill text-success"></i>
          </div>
          {% elif participant.is_muted %}
          <div class="ms-auto">
            <i class="bi bi-mic-mute text-danger"></i>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Chat -->
    <div class="meeting-sidebar">
      <h5><i class="bi bi-chat-dots"></i> Chat</h5>
      <hr />
      <div class="chat-container" id="chatMessages">
        <div class="chat-message message-other">
          <div class="message-sender">John Doe</div>
          <div>Hello everyone! Welcome to the meeting.</div>
          <div class="message-time">10:00 AM</div>
        </div>
        <div class="chat-message message-mine">
          <div>Thanks for organizing this!</div>
          <div class="message-time">10:01 AM</div>
        </div>
        <!-- More messages will be added dynamically -->
      </div>

      <form id="chatForm" class="mt-2">
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            id="messageInput"
            placeholder="Type your message..."
          />
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Meeting Notes Section -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>Meeting Notes</span>
        <div>
          <button class="btn btn-sm btn-outline-primary" id="saveNotes">
            <i class="bi bi-save"></i> Save
          </button>
          <button class="btn btn-sm btn-outline-secondary ms-1" id="shareNotes">
            <i class="bi bi-share"></i> Share
          </button>
        </div>
      </div>
      <div class="card-body">
        <textarea
          class="form-control"
          id="meetingNotes"
          rows="6"
          placeholder="Take notes during the meeting..."
        >
{{ meeting.notes|default("") }}</textarea
        >
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div
  class="modal fade"
  id="inviteModal"
  tabindex="-1"
  aria-labelledby="inviteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inviteModalLabel">Invite Participants</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="inviteForm">
          <div class="mb-3">
            <label for="emailInput" class="form-label">Email Addresses</label>
            <textarea
              class="form-control"
              id="emailInput"
              rows="3"
              placeholder="Enter email addresses separated by commas"
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="messageInput" class="form-label"
              >Message (Optional)</label
            >
            <textarea
              class="form-control"
              id="inviteMessageInput"
              rows="3"
              placeholder="Add a personalized message to your invitation"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="sendInvites">
          Send Invites
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="/static/js/common.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize UI elements
    const inviteBtn = document.getElementById("inviteBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const copyLink = document.getElementById("copyLink");
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("messageInput");
    const chatMessages = document.getElementById("chatMessages");
    const meetingNotes = document.getElementById("meetingNotes");
    const saveNotes = document.getElementById("saveNotes");

    // Video controls
    const btnMute = document.getElementById("btnMute");
    const btnVideo = document.getElementById("btnVideo");
    const btnScreen = document.getElementById("btnScreen");

    // Modal initialization
    const inviteModal = new bootstrap.Modal(
      document.getElementById("inviteModal")
    );

    // Event listeners
    inviteBtn.addEventListener("click", function () {
      inviteModal.show();
    });

    copyLink.addEventListener("click", function () {
      const meetingLink =
        document.querySelector('[id="copyLink"]').previousElementSibling
          .textContent;
      navigator.clipboard.writeText(meetingLink).then(function () {
        showToast("Meeting link copied to clipboard!");
      });
    });

    chatForm.addEventListener("submit", function (e) {
      e.preventDefault();
      if (messageInput.value.trim() !== "") {
        sendChatMessage(messageInput.value);
        messageInput.value = "";
      }
    });

    saveNotes.addEventListener("click", function () {
      saveMeetingNotes(meetingNotes.value);
    });

    leaveBtn.addEventListener("click", function () {
      if (confirm("Are you sure you want to leave this meeting?")) {
        leaveMeeting();
      }
    });

    // Video control event listeners
    btnMute.addEventListener("click", toggleMute);
    btnVideo.addEventListener("click", toggleVideo);
    btnScreen.addEventListener("click", toggleScreenShare);

    // Simulated functions (to be replaced with actual implementations)
    function sendChatMessage(message) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });

      const messageHTML = `
                <div class="chat-message message-mine">
                    <div>${message}</div>
                    <div class="message-time">${timeStr}</div>
                </div>
            `;

      chatMessages.innerHTML += messageHTML;
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Here you would typically send the message to a backend API
      console.log("Sending message:", message);
    }

    function saveMeetingNotes(notes) {
      // Here you would save the notes to the backend
      console.log("Saving notes:", notes);
      showToast("Meeting notes saved successfully!");
    }

    function leaveMeeting() {
      // Here you would handle leaving the meeting
      console.log("Leaving meeting");
      window.location.href = "/meeting";
    }

    function toggleMute() {
      const icon = btnMute.querySelector("i");
      if (icon.classList.contains("bi-mic")) {
        icon.classList.remove("bi-mic");
        icon.classList.add("bi-mic-mute");
        btnMute.classList.add("btn-danger");
        // Mute audio logic would go here
      } else {
        icon.classList.remove("bi-mic-mute");
        icon.classList.add("bi-mic");
        btnMute.classList.remove("btn-danger");
        // Unmute audio logic would go here
      }
    }

    function toggleVideo() {
      const icon = btnVideo.querySelector("i");
      if (icon.classList.contains("bi-camera-video")) {
        icon.classList.remove("bi-camera-video");
        icon.classList.add("bi-camera-video-off");
        btnVideo.classList.add("btn-danger");
        // Turn off video logic would go here
      } else {
        icon.classList.remove("bi-camera-video-off");
        icon.classList.add("bi-camera-video");
        btnVideo.classList.remove("btn-danger");
        // Turn on video logic would go here
      }
    }

    function toggleScreenShare() {
      const icon = btnScreen.querySelector("i");
      if (icon.classList.contains("bi-display")) {
        icon.classList.remove("bi-display");
        icon.classList.add("bi-display-fill");
        btnScreen.classList.add("btn-primary");
        // Start screen sharing logic would go here
      } else {
        icon.classList.remove("bi-display-fill");
        icon.classList.add("bi-display");
        btnScreen.classList.remove("btn-primary");
        // Stop screen sharing logic would go here
      }
    }

    // Initialize meeting connection
    initializeMeeting();

    function initializeMeeting() {
      // This would be replaced with actual WebRTC or similar setup code
      console.log("Initializing meeting connection...");

      // Simulate receiving a message after a delay
      setTimeout(function () {
        const messageHTML = `
                    <div class="chat-message message-other">
                        <div class="message-sender">Jane Smith</div>
                        <div>I've shared some documents in the meeting resources.</div>
                        <div class="message-time">10:05 AM</div>
                    </div>
                `;

        chatMessages.innerHTML += messageHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 5000);
    }
  });
</script>
{% endblock %}
