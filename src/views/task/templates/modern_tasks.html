{% extends "core/templates/base.html" %}

{% block title %}Tasks | CSA Platform{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dragula/dist/dragula.min.css">
<style>
    .task-board {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding: 10px 0;
        min-height: calc(100vh - 300px);
    }
    
    .task-column {
        background: #f8f9fa;
        border-radius: 5px;
        min-width: 300px;
        max-width: 300px;
        display: flex;
        flex-direction: column;
    }
    
    .task-column-header {
        padding: 15px;
        background-color: var(--secondary-color);
        color: white;
        border-radius: 5px 5px 0 0;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .column-todo .task-column-header {
        background-color: #6c757d;
    }
    
    .column-in-progress .task-column-header {
        background-color: #007bff;
    }
    
    .column-review .task-column-header {
        background-color: #fd7e14;
    }
    
    .column-done .task-column-header {
        background-color: #28a745;
    }
    
    .task-column-body {
        padding: 15px;
        flex-grow: 1;
        overflow-y: auto;
        max-height: calc(100vh - 400px);
    }
    
    .task-count {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.8rem;
    }
    
    .task-card {
        background: white;
        border-radius: 3px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #6c757d;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .task-card:hover {
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        transform: translateY(-2px);
    }
    
    .task-card.priority-high {
        border-left-color: #dc3545;
    }
    
    .task-card.priority-medium {
        border-left-color: #fd7e14;
    }
    
    .task-card.priority-low {
        border-left-color: #28a745;
    }
    
    .task-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .task-description {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
    }
    
    .task-due {
        color: #6c757d;
    }
    
    .task-due.overdue {
        color: #dc3545;
        font-weight: bold;
    }
    
    .task-assignee {
        display: flex;
        align-items: center;
    }
    
    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }
    
    .task-filter-row {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .filter-label {
        font-size: 0.8rem;
        font-weight: bold;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .dashboard-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        padding: 15px;
        display: flex;
        align-items: center;
    }
    
    .summary-icon {
        font-size: 2rem;
        margin-right: 15px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        color: white;
    }
    
    .summary-icon-blue {
        background-color: #007bff;
    }
    
    .summary-icon-green {
        background-color: #28a745;
    }
    
    .summary-icon-orange {
        background-color: #fd7e14;
    }
    
    .summary-icon-red {
        background-color: #dc3545;
    }
    
    .summary-content {
        flex-grow: 1;
    }
    
    .summary-title {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .summary-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block header %}Task Management{% endblock %}

{% block header_actions %}
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleView">
            <i class="bi bi-grid"></i> Board View
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleListView">
            <i class="bi bi-list"></i> List View
        </button>
    </div>
    <button type="button" class="btn btn-sm btn-primary" id="newTaskBtn">
        <i class="bi bi-plus"></i> New Task
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="dashboard-summary">
    <div class="summary-card">
        <div class="summary-icon summary-icon-blue">
            <i class="bi bi-list-check"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">TOTAL TASKS</div>
            <div class="summary-value">{{ task_stats.total }}</div>
        </div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon summary-icon-orange">
            <i class="bi bi-hourglass-split"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">IN PROGRESS</div>
            <div class="summary-value">{{ task_stats.in_progress }}</div>
        </div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon summary-icon-red">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">OVERDUE</div>
            <div class="summary-value">{{ task_stats.overdue }}</div>
        </div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon summary-icon-green">
            <i class="bi bi-check-circle"></i>
        </div>
        <div class="summary-content">
            <div class="summary-title">COMPLETED</div>
            <div class="summary-value">{{ task_stats.completed }}</div>
        </div>
    </div>
</div>

<!-- Task Filters -->
<div class="task-filter-row">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="filter-label">PROJECT</div>
            <select class="form-select form-select-sm" id="projectFilter">
                <option value="">All Projects</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <div class="filter-label">ASSIGNEE</div>
            <select class="form-select form-select-sm" id="assigneeFilter">
                <option value="">All Assignees</option>
                <option value="me">Assigned to Me</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <div class="filter-label">PRIORITY</div>
            <select class="form-select form-select-sm" id="priorityFilter">
                <option value="">All Priorities</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        <div class="col-md-2">
            <div class="filter-label">DUE DATE</div>
            <input type="text" class="form-control form-control-sm" id="dueDateFilter" placeholder="Select date">
        </div>
        <div class="col-md-2">
            <div class="filter-label">SEARCH</div>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="searchInput" placeholder="Search tasks...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Board View -->
<div id="boardView">
    <div class="task-board">
        <!-- To Do Column -->
        <div class="task-column column-todo">
            <div class="task-column-header">
                <span>To Do</span>
                <span class="task-count">{{ columns.todo|length }}</span>
            </div>
            <div class="task-column-body" id="todo-tasks">
                {% for task in columns.todo %}
                <div class="task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-description">{{ task.description }}</div>
                    <div class="task-meta">
                        <div class="task-due {% if task.is_overdue %}overdue{% endif %}">
                            <i class="bi bi-calendar"></i> {{ task.due_date }}
                        </div>
                        <div class="task-assignee">
                            <div class="assignee-avatar" title="{{ task.assignee.name }}">
                                {{ task.assignee.initials }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- In Progress Column -->
        <div class="task-column column-in-progress">
            <div class="task-column-header">
                <span>In Progress</span>
                <span class="task-count">{{ columns.in_progress|length }}</span>
            </div>
            <div class="task-column-body" id="in-progress-tasks">
                {% for task in columns.in_progress %}
                <div class="task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-description">{{ task.description }}</div>
                    <div class="task-meta">
                        <div class="task-due {% if task.is_overdue %}overdue{% endif %}">
                            <i class="bi bi-calendar"></i> {{ task.due_date }}
                        </div>
                        <div class="task-assignee">
                            <div class="assignee-avatar" title="{{ task.assignee.name }}">
                                {{ task.assignee.initials }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Review Column -->
        <div class="task-column column-review">
            <div class="task-column-header">
                <span>Review</span>
                <span class="task-count">{{ columns.review|length }}</span>
            </div>
            <div class="task-column-body" id="review-tasks">
                {% for task in columns.review %}
                <div class="task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-description">{{ task.description }}</div>
                    <div class="task-meta">
                        <div class="task-due {% if task.is_overdue %}overdue{% endif %}">
                            <i class="bi bi-calendar"></i> {{ task.due_date }}
                        </div>
                        <div class="task-assignee">
                            <div class="assignee-avatar" title="{{ task.assignee.name }}">
                                {{ task.assignee.initials }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Done Column -->
        <div class="task-column column-done">
            <div class="task-column-header">
                <span>Done</span>
                <span class="task-count">{{ columns.done|length }}</span>
            </div>
            <div class="task-column-body" id="done-tasks">
                {% for task in columns.done %}
                <div class="task-card priority-{{ task.priority }}" data-task-id="{{ task.id }}">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-description">{{ task.description }}</div>
                    <div class="task-meta">
                        <div class="task-due {% if task.is_overdue %}overdue{% endif %}">
                            <i class="bi bi-calendar"></i> {{ task.due_date }}
                        </div>
                        <div class="task-assignee">
                            <div class="assignee-avatar" title="{{ task.assignee.name }}">
                                {{ task.assignee.initials }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task List View (hidden by default) -->
<div id="listView" style="display: none;">
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover" id="tasksTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Project</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Assignee</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in all_tasks %}
                        <tr data-task-id="{{ task.id }}">
                            <td>{{ task.title }}</td>
                            <td>{{ task.project.name }}</td>
                            <td>
                                <span class="badge {% if task.status == 'done' %}bg-success{% elif task.status == 'in_progress' %}bg-primary{% elif task.status == 'review' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ task.status|title|replace('_', ' ') }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if task.priority == 'high' %}bg-danger{% elif task.priority == 'medium' %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ task.priority|title }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="assignee-avatar me-2" title="{{ task.assignee.name }}">
                                        {{ task.assignee.initials }}
                                    </div>
                                    <span>{{ task.assignee.name }}</span>
                                </div>
                            </td>
                            <td class="{% if task.is_overdue %}text-danger fw-bold{% endif %}">
                                {{ task.due_date }}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary btn-view" data-task-id="{{ task.id }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-edit" data-task-id="{{ task.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-delete" data-task-id="{{ task.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="taskTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="col-md-4">
                            <label for="taskStatus" class="form-label">Status</label>
                            <select class="form-select" id="taskStatus" required>
                                <option value="todo">To Do</option>
                                <option value="in_progress">In Progress</option>
                                <option value="review">Review</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskProject" class="form-label">Project</label>
                            <select class="form-select" id="taskProject" required>
                                <option value="">Select Project</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskAssignee" class="form-label">Assignee</label>
                            <select class="form-select" id="taskAssignee" required>
                                <option value="">Select Assignee</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskDueDate" class="form-label">Due Date</label>
                            <input type="text" class="form-control" id="taskDueDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="taskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="taskPriority" required>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">Save Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailsModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h3 id="detailsTitle"></h3>
                        <p class="text-muted" id="detailsDescription"></p>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Comments</h6>
                            </div>
                            <div class="card-body">
                                <div id="comments">
                                    <!-- Comments will be loaded here -->
                                </div>
                                <div class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="commentInput" placeholder="Add a comment...">
                                        <button class="btn btn-primary" id="addCommentBtn">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3">Details</h6>
                                
                                <div class="mb-2">
                                    <span class="text-muted">Status:</span>
                                    <span class="badge bg-secondary float-end" id="detailsStatus">To Do</span>
                                </div>
                                
                                <div class="mb-2">
                                    <span class="text-muted">Priority:</span>
                                    <span class="badge bg-success float-end" id="detailsPriority">Low</span>
                                </div>
                                
                                <div class="mb-2">
                                    <span class="text-muted">Due Date:</span>
                                    <span class="float-end" id="detailsDueDate"></span>
                                </div>
                                
                                <div class="mb-2">
                                    <span class="text-muted">Created:</span>
                                    <span class="float-end" id="detailsCreated"></span>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-2">
                                    <span class="text-muted">Project:</span>
                                    <span class="float-end" id="detailsProject"></span>
                                </div>
                                
                                <div class="mb-4">
                                    <span class="text-muted">Assignee:</span>
                                    <div class="float-end d-flex align-items-center">
                                        <div class="assignee-avatar me-2" id="detailsAssigneeAvatar"></div>
                                        <span id="detailsAssignee"></span>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" id="editTaskFromDetails">
                                        <i class="bi bi-pencil"></i> Edit Task
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" id="deleteTaskFromDetails">
                                        <i class="bi bi-trash"></i> Delete Task
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/dragula/dist/dragula.min.js"></script>
<script src="/static/js/common.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date pickers
        flatpickr("#taskDueDate", {
            dateFormat: "Y-m-d",
            defaultDate: new Date().fp_incr(7) // Default to 7 days from now
        });
        
        flatpickr("#dueDateFilter", {
            dateFormat: "Y-m-d",
            allowInput: true,
            wrap: true
        });
        
        // Initialize drag and drop
        const drake = dragula([
            document.getElementById('todo-tasks'),
            document.getElementById('in-progress-tasks'),
            document.getElementById('review-tasks'),
            document.getElementById('done-tasks')
        ]);
        
        // Handle drop event to update task status
        drake.on('drop', function(el, target) {
            const taskId = el.getAttribute('data-task-id');
            let newStatus = '';
            
            switch(target.id) {
                case 'todo-tasks':
                    newStatus = 'todo';
                    break;
                case 'in-progress-tasks':
                    newStatus = 'in_progress';
                    break;
                case 'review-tasks':
                    newStatus = 'review';
                    break;
                case 'done-tasks':
                    newStatus = 'done';
                    break;
            }
            
            if (newStatus) {
                updateTaskStatus(taskId, newStatus);
            }
        });
        
        // Toggle between board and list views
        const boardView = document.getElementById('boardView');
        const listView = document.getElementById('listView');
        const toggleViewBtn = document.getElementById('toggleView');
        const toggleListViewBtn = document.getElementById('toggleListView');
        
        toggleViewBtn.addEventListener('click', function() {
            boardView.style.display = 'block';
            listView.style.display = 'none';
            toggleViewBtn.classList.add('active');
            toggleListViewBtn.classList.remove('active');
        });
        
        toggleListViewBtn.addEventListener('click', function() {
            boardView.style.display = 'none';
            listView.style.display = 'block';
            toggleViewBtn.classList.remove('active');
            toggleListViewBtn.classList.add('active');
        });
        
        // Initialize task modals
        const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
        const taskDetailsModal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        const newTaskBtn = document.getElementById('newTaskBtn');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        
        newTaskBtn.addEventListener('click', function() {
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskModalLabel').textContent = 'New Task';
            taskModal.show();
        });
        
        saveTaskBtn.addEventListener('click', function() {
            if (validateForm(document.getElementById('taskForm'))) {
                saveTask();
            }
        });
        
        // Task card click to show details
        document.querySelectorAll('.task-card').forEach(card => {
            card.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                showTaskDetails(taskId);
            });
        });
        
        // Table view action buttons
        document.querySelectorAll('.btn-view').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const taskId = this.getAttribute('data-task-id');
                showTaskDetails(taskId);
            });
        });
        
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const taskId = this.getAttribute('data-task-id');
                editTask(taskId);
            });
        });
        
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const taskId = this.getAttribute('data-task-id');
                confirmDeleteTask(taskId);
            });
        });
        
        // Task details modal actions
        document.getElementById('editTaskFromDetails').addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            taskDetailsModal.hide();
            editTask(taskId);
        });
        
        document.getElementById('deleteTaskFromDetails').addEventListener('click', function() {
            const taskId = this.getAttribute('data-task-id');
            taskDetailsModal.hide();
            confirmDeleteTask(taskId);
        });
        
        // Filter events
        document.getElementById('projectFilter').addEventListener('change', applyFilters);
        document.getElementById('assigneeFilter').addEventListener('change', applyFilters);
        document.getElementById('priorityFilter').addEventListener('change', applyFilters);
        document.getElementById('searchBtn').addEventListener('click', applyFilters);
        document.getElementById('dueDateFilter').addEventListener('change', applyFilters);
        
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        
        // Comment input
        document.getElementById('addCommentBtn').addEventListener('click', function() {
            const commentInput = document.getElementById('commentInput');
            const taskId = document.getElementById('editTaskFromDetails').getAttribute('data-task-id');
            
            if (commentInput.value.trim() !== '') {
                addComment(taskId, commentInput.value);
                commentInput.value = '';
            }
        });
        
        // Functions
        function updateTaskStatus(taskId, status) {
            // Call API to update task status
            apiRequest(`/api/v1/tasks/${taskId}/status`, 'PATCH', { status })
                .then(response => {
                    showToast(`Task status updated to ${status.replace('_', ' ')}`, 'success');
                })
                .catch(error => {
                    console.error('Error updating task status:', error);
                    showToast('Failed to update task status', 'danger');
                });
        }
        
        function showTaskDetails(taskId) {
            // Call API to get task details
            apiRequest(`/api/v1/tasks/${taskId}`, 'GET')
                .then(task => {
                    // Fill in task details
                    document.getElementById('detailsTitle').textContent = task.title;
                    document.getElementById('detailsDescription').textContent = task.description;
                    
                    // Update status badge
                    const statusBadge = document.getElementById('detailsStatus');
                    statusBadge.textContent = task.status.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                    statusBadge.className = 'badge float-end';
                    
                    if (task.status === 'todo') statusBadge.classList.add('bg-secondary');
                    else if (task.status === 'in_progress') statusBadge.classList.add('bg-primary');
                    else if (task.status === 'review') statusBadge.classList.add('bg-warning');
                    else if (task.status === 'done') statusBadge.classList.add('bg-success');
                    
                    // Update priority badge
                    const priorityBadge = document.getElementById('detailsPriority');
                    priorityBadge.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
                    priorityBadge.className = 'badge float-end';
                    
                    if (task.priority === 'high') priorityBadge.classList.add('bg-danger');
                    else if (task.priority === 'medium') priorityBadge.classList.add('bg-warning');
                    else if (task.priority === 'low') priorityBadge.classList.add('bg-success');
                    
                    // Fill other details
                    document.getElementById('detailsDueDate').textContent = formatDate(task.due_date);
                    document.getElementById('detailsCreated').textContent = formatDate(task.created_at);
                    document.getElementById('detailsProject').textContent = task.project.name;
                    document.getElementById('detailsAssignee').textContent = task.assignee.name;
                    document.getElementById('detailsAssigneeAvatar').textContent = task.assignee.initials;
                    
                    // Set task ID for action buttons
                    document.getElementById('editTaskFromDetails').setAttribute('data-task-id', task.id);
                    document.getElementById('deleteTaskFromDetails').setAttribute('data-task-id', task.id);
                    
                    // Load comments
                    loadComments(task.id);
                    
                    // Show modal
                    taskDetailsModal.show();
                })
                .catch(error => {
                    console.error('Error fetching task details:', error);
                    showToast('Failed to load task details', 'danger');
                });
        }
        
        function editTask(taskId) {
            // Call API to get task for editing
            apiRequest(`/api/v1/tasks/${taskId}`, 'GET')
                .then(task => {
                    // Fill the form with task data
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description;
                    document.getElementById('taskStatus').value = task.status;
                    document.getElementById('taskProject').value = task.project.id;
                    document.getElementById('taskAssignee').value = task.assignee.id;
                    document.getElementById('taskDueDate').value = task.due_date;
                    document.getElementById('taskPriority').value = task.priority;
                    
                    // Update modal title and show
                    document.getElementById('taskModalLabel').textContent = 'Edit Task';
                    taskModal.show();
                })
                .catch(error => {
                    console.error('Error fetching task for editing:', error);
                    showToast('Failed to load task data', 'danger');
                });
        }
        
        function saveTask() {
            const taskId = document.getElementById('taskId').value;
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                status: document.getElementById('taskStatus').value,
                project_id: document.getElementById('taskProject').value,
                assignee_id: document.getElementById('taskAssignee').value,
                due_date: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value
            };
            
            // Determine if this is an create or update
            const method = taskId ? 'PUT' : 'POST';
            const url = taskId ? `/api/v1/tasks/${taskId}` : '/api/v1/tasks';
            
            apiRequest(url, method, taskData)
                .then(response => {
                    taskModal.hide();
                    showToast(taskId ? 'Task updated successfully' : 'Task created successfully', 'success');
                    // Reload page to show changes
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error saving task:', error);
                    showToast('Failed to save task', 'danger');
                });
        }
        
        function confirmDeleteTask(taskId) {
            confirmDialog('Are you sure you want to delete this task?', () => {
                deleteTask(taskId);
            });
        }
        
        function deleteTask(taskId) {
            apiRequest(`/api/v1/tasks/${taskId}`, 'DELETE')
                .then(response => {
                    showToast('Task deleted successfully', 'success');
                    // Reload page to show changes
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    showToast('Failed to delete task', 'danger');
                });
        }
        
        function loadComments(taskId) {
            // Call API to get task comments
            apiRequest(`/api/v1/tasks/${taskId}/comments`, 'GET')
                .then(comments => {
                    const commentsContainer = document.getElementById('comments');
                    commentsContainer.innerHTML = '';
                    
                    if (comments.length === 0) {
                        commentsContainer.innerHTML = '<p class="text-center text-muted">No comments yet</p>';
                        return;
                    }
                    
                    comments.forEach(comment => {
                        const commentHTML = `
                            <div class="d-flex mb-3">
                                <div class="assignee-avatar me-2" title="${comment.user.name}">
                                    ${comment.user.initials}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-0">${comment.user.name}</h6>
                                        <small class="text-muted">${formatDateTime(comment.created_at)}</small>
                                    </div>
                                    <div>${comment.content}</div>
                                </div>
                            </div>
                        `;
                        
                        commentsContainer.innerHTML += commentHTML;
                    });
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    document.getElementById('comments').innerHTML = '<p class="text-center text-danger">Failed to load comments</p>';
                });
        }
        
        function addComment(taskId, content) {
            apiRequest(`/api/v1/tasks/${taskId}/comments`, 'POST', { content })
                .then(response => {
                    showToast('Comment added', 'success');
                    loadComments(taskId);
                })
                .catch(error => {
                    console.error('Error adding comment:', error);
                    showToast('Failed to add comment', 'danger');
                });
        }
        
        function applyFilters() {
            const project = document.getElementById('projectFilter').value;
            const assignee = document.getElementById('assigneeFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const dueDate = document.getElementById('dueDateFilter').value;
            const searchText = document.getElementById('searchInput').value;
            
            // Build query string
            const params = new URLSearchParams();
            if (project) params.append('project_id', project);
            if (assignee) params.append('assignee_id', assignee);
            if (priority) params.append('priority', priority);
            if (dueDate) params.append('due_date', dueDate);
            if (searchText) params.append('search', searchText);
            
            // Redirect with filters
            window.location.href = `/tasks?${params.toString()}`;
        }
    });
</script>
{% endblock %}
